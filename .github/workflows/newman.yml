name: API tests (Newman)

on:
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:

  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ Ð¿ÑƒÑˆÐ°Ð¼ / PR
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ
  # GitHub cron Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð² UTC
  # ÐœÐ¾ÑÐºÐ²Ð° = UTC+3
  # ÐÐ• Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ 22:00 Ð´Ð¾ 07:00 ÐœÐ¡Ðš
  schedule:
    # 07:00â€“21:45 ÐœÐ¡Ðš (UTC 04â€“18)
    - cron: "*/15 4-18 * * *"
    # 21:00â€“21:45 ÐœÐ¡Ðš (UTC 18)
    - cron: "*/15 19-21 * * *"

jobs:
  newman:
    runs-on: ubuntu-latest

    permissions:
      checks: write
      contents: write
      pull-requests: read

    steps:
      # =========================================================
      # ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ (Ð²ÐµÑ‚ÐºÐ° main)
      # =========================================================
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # =========================================================
      # ðŸŸ¢ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Node.js (Ð½ÑƒÐ¶ÐµÐ½ Ð´Ð»Ñ Newman)
      # =========================================================
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =========================================================
      # ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Newman
      # =========================================================
      - name: ðŸ“¦ Install Newman
        run: npm install -g newman

      # =========================================================
      # ðŸ§¾ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ HTML-Ñ€ÐµÐ¿Ð¾Ñ€Ñ‚Ñ‘Ñ€
      # =========================================================
      - name: ðŸ§¾ Install Newman HTML Reporter
        run: npm install -g newman-reporter-htmlextra

      # =========================================================
      # ðŸ†” Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ RUN_ID (Ð´Ð°Ñ‚Ð° + Ð²Ñ€ÐµÐ¼Ñ)
      # =========================================================
      - name: ðŸ†” Generate RUN_ID
        run: |
          RUN_ID=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Run ID: $RUN_ID"

      # =========================================================
      # ðŸ·ï¸ ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ð¿Ñ€Ð¾Ð³Ð¾Ð½Ð°:
      # Manual / Auto / Night
      # =========================================================
      - name: ðŸ·ï¸ Determine RUN_TYPE
        run: |
          RUN_TYPE="Auto"

          # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RUN_TYPE="Manual"
          fi

          # ÐÐ¾Ñ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº (22:00â€“07:00 ÐœÐ¡Ðš â†’ 19â€“04 UTC)
          HOUR_UTC=$(date -u +"%H")
          if [ "$HOUR_UTC" -ge 19 ] || [ "$HOUR_UTC" -lt 4 ]; then
            RUN_TYPE="Night"
          fi

          echo "RUN_TYPE=$RUN_TYPE" >> $GITHUB_ENV
          echo "Run type: $RUN_TYPE"

      # =========================================================
      # â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÐº Postman ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
      # =========================================================
      - name: â–¶ï¸ Run Postman collection
        continue-on-error: true
        run: |
          mkdir -p reports
          mkdir -p public/runs/${RUN_ID}__${RUN_TYPE}

          newman run "postman/Flipper API.postman_collection.json" \
            --timeout-request 60000 \
            --delay-request 200 \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/newman-report.html \
            --reporter-junit-export reports/newman-report.xml

          cp reports/newman-report.html public/runs/${RUN_ID}__${RUN_TYPE}/index.html

      # =========================================================
      # ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ ÐºÐ°Ðº artifacts
      # =========================================================
      - name: ðŸ“¤ Upload Newman reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/

      # =========================================================
      # ðŸ“Š ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ JUnit Ð² GitHub Summary
      # =========================================================
      - name: ðŸ“Š Publish test results (JUnit â†’ Summary)
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/newman-report.xml

      # =========================================================
      # ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ allurectl (CLI Ð´Ð»Ñ TestOps)
      # =========================================================
      - name: ðŸ“¥ Install allurectl
        if: always()
        run: |
          curl -o allurectl -L https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64
          chmod +x allurectl
          sudo mv allurectl /usr/local/bin/allurectl

      # =========================================================
      # ðŸ“Š Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð² Allure TestOps
      # =========================================================
      - name: ðŸ“Š Upload results to Allure TestOps
        if: always()
        env:
          TESTOPS_ENDPOINT: ${{ secrets.TESTOPS_ENDPOINT }}
          TESTOPS_TOKEN: ${{ secrets.TESTOPS_TOKEN }}
          TESTOPS_PROJECT_ID: ${{ secrets.TESTOPS_PROJECT_ID }}
        run: |
          export ALLURE_ENDPOINT=${TESTOPS_ENDPOINT}
          export ALLURE_TOKEN=${TESTOPS_TOKEN}

          LAUNCH_URL=$(allurectl upload reports/newman-report.xml \
            --project-id ${TESTOPS_PROJECT_ID} \
            --launch-name "Flipper API â€¢ ${RUN_TYPE} â€¢ ${RUN_ID}" \
            --launch-tags "api,newman,${RUN_TYPE}" \
            | grep -Eo 'https://[^ ]+')

          echo "ALLURE_LAUNCH_URL=$LAUNCH_URL" >> $GITHUB_ENV


      # =========================================================
      # ðŸ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python
      # =========================================================
      - name: ðŸ Setup Python
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # =========================================================
      # ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python-Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      # =========================================================
      - name: ðŸ“¦ Install Python dependencies
        if: always()
        run: pip install requests

      # =========================================================
      # ðŸ“© ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð² Telegram
      # =========================================================
      - name: ðŸ“© Send Telegram report
        if: always()
        env:
          TGBOT: ${{ secrets.TGBOT }}
          CHATID: ${{ secrets.CHATID }}
          RUN_ID: ${{ env.RUN_ID }}
          RUN_TYPE: ${{ env.RUN_TYPE }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ALLURE_LAUNCH_URL: ${{ env.ALLURE_LAUNCH_URL }}
        run: python scripts/send_telegram_report.py

      # =========================================================
      # ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° Ð² GitHub Pages
      # =========================================================
      - name: ðŸš€ Deploy to GitHub Pages
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          cp -r public /tmp/public

          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages

          mkdir -p runs
          cp -r /tmp/public/runs/${RUN_ID}__${RUN_TYPE} runs/

          touch .nojekyll

          git add runs .nojekyll
          git commit -m "deploy: ${RUN_ID} (${RUN_TYPE})" || echo "Nothing to commit"
          git push origin gh-pages

      # =========================================================
      # ðŸ”— ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð² Summary
      # =========================================================
      - name: ðŸ”— Publish report link to Summary
        if: always()
        run: |
          echo "## ðŸ§ª Newman API Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ð¢Ð¸Ð¿ Ð¿Ñ€Ð¾Ð³Ð¾Ð½Ð°:** ${RUN_TYPE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **HTML Report:**" >> $GITHUB_STEP_SUMMARY
          echo "https://nikitamiloserdov.github.io/fl-test/runs/${RUN_ID}__${RUN_TYPE}/" >> $GITHUB_STEP_SUMMARY
