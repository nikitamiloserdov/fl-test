name: API tests (Newman)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  newman:
    runs-on: ubuntu-latest

    permissions:
      checks: write
      contents: write
      pull-requests: read

    steps:
      # ðŸ“¥ Checkout repository (main)
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ðŸŸ¢ Setup Node.js
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ðŸ“¦ Install Newman
      - name: ðŸ“¦ Install Newman
        run: npm install -g newman

      # ðŸ§¾ Install Newman HTML Reporter
      - name: ðŸ§¾ Install Newman HTML Reporter
        run: npm install -g newman-reporter-htmlextra

      # ðŸ†” Generate RUN_ID
      - name: ðŸ†” Generate RUN_ID
        run: |
          RUN_ID=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Run ID: $RUN_ID"

      # â–¶ï¸ Run Postman collection
      - name: â–¶ï¸ Run Postman collection
        continue-on-error: true
        run: |
          mkdir -p reports
          mkdir -p public/runs/${RUN_ID}

          newman run "postman/Flipper API.postman_collection.json" \
            --timeout-request 60000 \
            --delay-request 200 \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/newman-report.html \
            --reporter-junit-export reports/newman-report.xml

          cp reports/newman-report.html public/runs/${RUN_ID}/index.html

      # ðŸ“¤ Upload Newman reports
      - name: ðŸ“¤ Upload Newman reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/

      # ðŸ“Š Publish JUnit results
      - name: ðŸ“Š Publish test results (JUnit â†’ Summary)
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/newman-report.xml

      # ðŸ Setup Python (ÐŸÐžÐšÐ ÐœÐ« Ð’ main)
      - name: ðŸ Setup Python
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ðŸ“¦ Install Python dependencies
      - name: ðŸ“¦ Install Python dependencies
        if: always()
        run: pip install requests

      # ðŸ“© Send Telegram report (ÐŸÐžÐšÐ ÐœÐ« Ð’ main)
      - name: ðŸ“© Send Telegram report
        if: always()
        env:
          TGBOT: ${{ secrets.TGBOT }}
          CHATID: ${{ secrets.CHATID }}
          RUN_ID: ${{ env.RUN_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python scripts/send_telegram_report.py

      # ðŸš€ Deploy to GitHub Pages (ÐŸÐžÐ¡Ð›Ð• Telegram)
      - name: ðŸš€ Deploy to GitHub Pages
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          cp -r public /tmp/public

          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages

          mkdir -p runs
          cp -r /tmp/public/runs/${RUN_ID} runs/

          touch .nojekyll

          git add runs .nojekyll
          git commit -m "deploy: ${RUN_ID}" || echo "Nothing to commit"
          git push origin gh-pages

      # ðŸ”— Publish report link to Summary
      - name: ðŸ”— Publish report link to Summary
        if: always()
        run: |
          echo "## ðŸ§ª Newman API Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **HTML Report:**" >> $GITHUB_STEP_SUMMARY
          echo "https://nikitamiloserdov.github.io/fl-test/runs/${RUN_ID}/" >> $GITHUB_STEP_SUMMARY
