name: API tests (Newman)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  newman:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      checks: write
      pull-requests: read

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install Newman
        run: npm install -g newman

      - name: ğŸ§¾ Install Newman HTML Reporter
        run: npm install -g newman-reporter-htmlextra

      # ğŸ” Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° â€” ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ
      - name: ğŸ” Debug repository structure
        run: |
          echo "Current directory:"
          pwd
          echo "Root files:"
          ls -la
          echo "Postman folder:"
          ls -la postman || true

      # â–¶ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      - name: â–¶ï¸ Run Postman collection
        run: |
          mkdir -p reports
        
          newman run "postman/Flipper API.postman_collection.json" \
            --timeout-request 60000 \
            --delay-request 200 \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/newman-report.html \
            --reporter-junit-export reports/newman-report.xml

      # ğŸ“¤ Artifacts (Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ)
      - name: ğŸ“¤ Upload Newman reports
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/

      # ğŸ“Š Summary Ğ² GitHub (JUnit)
      - name: ğŸ“Š Publish test results (JUnit â†’ Summary)
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: reports/newman-report.xml

      # ğŸ•’ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ¿Ğ°Ğ¿ĞºĞ¸ Ñ Ñ‚Ğ°Ğ¹Ğ¼ÑÑ‚ĞµĞ¼Ğ¿Ğ¾Ğ¼
      - name: ğŸ•’ Prepare run folder
        id: runfolder
        run: |
          RUN_ID=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          mkdir -p gh-pages/runs/$RUN_ID
          cp reports/newman-report.html gh-pages/runs/$RUN_ID/index.html
          cp reports/newman-report.html gh-pages/index.html

      # ğŸŒ Deploy GitHub Pages (Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹)
      - name: ğŸŒ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: gh-pages
          keep_files: true
