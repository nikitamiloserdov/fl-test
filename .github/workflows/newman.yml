name: API tests (Newman)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  newman:
    runs-on: ubuntu-latest

    permissions:
       checks: write
       contents: write
       pull-requests: read

    steps:
      # ğŸ“¥ Checkout
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ğŸŸ¢ Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ğŸ“¦ Newman
      - name: ğŸ“¦ Install Newman
        run: npm install -g newman

      # ğŸ§¾ HTML reporter
      - name: ğŸ§¾ Install Newman HTML Reporter
        run: npm install -g newman-reporter-htmlextra

      # ğŸ” Debug
      - name: ğŸ” Debug repository structure
        run: |
          pwd
          ls -la
          ls -la postman || true

      # ğŸ†” RUN_ID
      - name: ğŸ†” Generate RUN_ID
        run: |
          RUN_ID=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Run ID: $RUN_ID"

      # â–¶ï¸ Newman run
      - name: â–¶ï¸ Run Postman collection
        continue-on-error: true
        run: |
          mkdir -p reports
          mkdir -p public/runs/${RUN_ID}

          newman run "postman/Flipper API.postman_collection.json" \
            --timeout-request 60000 \
            --delay-request 200 \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/newman-report.html \
            --reporter-junit-export reports/newman-report.xml

          cp reports/newman-report.html public/runs/${RUN_ID}/index.html

      # ğŸ“¤ Artifacts
      - name: ğŸ“¤ Upload Newman reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/

      # ğŸ“Š JUnit summary
      - name: ğŸ“Š Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/newman-report.xml

      # ğŸš€ Deploy Pages
      - name: ğŸš€ Deploy to GitHub Pages
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          cp -r public /tmp/public

          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages

          mkdir -p runs
          cp -r /tmp/public/runs/${RUN_ID} runs/

          touch .nojekyll

          git add runs .nojekyll
          git commit -m "deploy: ${RUN_ID}" || echo "Nothing to commit"
          git push origin gh-pages

      # ğŸ”— Summary link
      - name: ğŸ”— Publish report link to Summary
        if: always()
        run: |
          echo "## ğŸ§ª Newman API Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **HTML Report:**" >> $GITHUB_STEP_SUMMARY
          echo "https://nikitamiloserdov.github.io/fl-test/runs/${RUN_ID}/" >> $GITHUB_STEP_SUMMARY


      - name: ğŸ”¥ FINAL DEBUG
        if: always()
        run: |
          echo "PWD:"
          pwd
          echo "ROOT:"
          ls -la
          echo "SCRIPTS:"
          ls -la scripts
          echo "FIND telegram:"
          find . -iname "*telegram*"
   

      # ğŸ†• ğŸ Setup Python
      - name: ğŸ Setup Python
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ğŸ†• ğŸ“¦ Install Python deps
      - name: ğŸ“¦ Install Python dependencies
        if: always()
        run: pip install requests

      # ğŸ†• ğŸ“© Send Telegram report
      - name: ğŸ“© Send Telegram report
        if: always()
        env:
          TGBOT: ${{ secrets.TGBOT }}
          CHATID: ${{ secrets.CHATID }}
          RUN_ID: ${{ env.RUN_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python scripts/send_telegram_report.py
